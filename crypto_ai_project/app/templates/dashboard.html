<!DOCTYPE html>
<html lang="hu">
  <head>
    <meta charset="utf-8" />
    <title>Crypto AI Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Tailwind (csak a kinézet miatt) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>

  <body class="bg-slate-900 text-slate-100">
    <div class="min-h-screen p-4 md:p-8">
      <h1 class="text-2xl md:text-3xl font-bold mb-4">
        Bitcoin AI Advisor Dashboard
      </h1>

      <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-4">
        <!-- Modell jelzés -->
        <div class="bg-slate-800 rounded-xl p-4">
          <h2 class="text-lg font-semibold mb-2">Jelzés</h2>
          <div id="signal" class="text-3xl font-bold">–</div>
          <div class="mt-2 text-sm text-slate-300">
            <div>Utolsó záróár: <span id="last_close">–</span> USD</div>
            <div>
              Következő ár predikció: <span id="next_price_pred">–</span> USD
            </div>
            <div>Várható változás: <span id="rel_change_pred">–</span> %</div>
          </div>
          <div class="mt-3 text-xs text-slate-400" id="model_error"></div>
        </div>

        <!-- Fear & Greed + News sentiment -->
        <div class="bg-slate-800 rounded-xl p-4">
          <h2 class="text-lg font-semibold mb-2">Hangulat</h2>
          <div>Fear &amp; Greed: <span id="fg_value">–</span></div>
          <div>News sentiment: <span id="news_sent_value">–</span></div>
          <canvas id="sentimentChart" class="mt-3"></canvas>
        </div>

        <!-- Intraday info -->
        <div class="bg-slate-800 rounded-xl p-4">
          <h2 class="text-lg font-semibold mb-2">Intraday (1m)</h2>
          <canvas id="intradayChart"></canvas>
        </div>

        <!-- LLM-mel módosított jelzés -->
        <div class="bg-slate-800 rounded-xl p-4">
          <h2 class="text-lg font-semibold mb-2">LLM jelzés finomhangolva</h2>
          <div class="text-sm text-slate-300 space-y-1">
            <div>
              <span class="text-xs text-slate-400">Alap jelzés:</span>
              <span id="base_signal">–</span>
            </div>
            <div>
              <span class="text-xs text-slate-400">LLM / heurisztika:</span>
              <span id="llm_signal" class="font-semibold">–</span>
            </div>
            <div>Változás (%): <span id="llm_change">–</span></div>
            <div>Kockázati score (0-1): <span id="llm_risk">–</span></div>
            <div>Mód: <span id="llm_mode">–</span></div>
            <div class="text-xs text-slate-400" id="llm_note"></div>
          </div>
        </div>
      </div>

      <!-- 1H OHLCV chart -->
      <div class="bg-slate-800 rounded-xl p-4 mb-4">
        <h2 class="text-lg font-semibold mb-2">BTCUSDT – 1H OHLCV</h2>
        <canvas id="ohlcvChart"></canvas>
      </div>

      <!-- Hosszútávú görbe + szórássáv -->
      <div class="bg-slate-800 rounded-xl p-4">
        <h2 class="text-lg font-semibold mb-2">
          Hosszútávú BTC trend (görbe + szórássáv)
        </h2>
        <canvas id="longCurveChart"></canvas>
      </div>

      <!-- LLM asszisztens (CryptoGPT) -->
      <div class="bg-slate-800 rounded-xl p-4 mt-4">
        <h2 class="text-lg font-semibold mb-2">LLM asszisztens</h2>
        <form id="chatForm" class="space-y-2">
          <label class="block text-sm text-slate-300" for="chat_question"
            >Kérdés</label
          >
          <textarea
            id="chat_question"
            class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-2 text-sm"
            rows="3"
            placeholder="Mit gondolsz a mai BTC mozgásról?"
          ></textarea>
          <button
            type="submit"
            class="px-3 py-2 bg-emerald-500 text-slate-900 rounded font-semibold"
          >
            Küldés
          </button>
          <span id="chat_status" class="text-xs text-slate-400"></span>
        </form>
        <div class="mt-3">
          <h3 class="text-sm font-semibold mb-1">Válasz</h3>
          <div
            id="chat_answer"
            class="bg-slate-900 border border-slate-700 rounded p-3 text-sm whitespace-pre-wrap"
          ></div>
        </div>
      </div>
    </div>

    <script>
      let ohlcvChart = null;
      let intradayChart = null;
      let sentimentChart = null;
      let longCurveChart = null;
      let lastAdjusted = null;

      async function fetchState() {
        const resp = await fetch("/api/state");
        return await resp.json();
      }

      async function fetchAdjusted() {
        const resp = await fetch("/api/llm/adjusted_forecast");
        return await resp.json();
      }

      function upsertCharts(state) {
        const ctxOhlcv = document.getElementById("ohlcvChart").getContext("2d");
        const ctxIntraday = document
          .getElementById("intradayChart")
          .getContext("2d");
        const ctxSent = document
          .getElementById("sentimentChart")
          .getContext("2d");
        const ctxLong = document
          .getElementById("longCurveChart")
          .getContext("2d");

        // ----- 1H OHLCV -----
        const candles = state.candles_1h || [];
        const labelsOhlc = candles.map((c) => c.time);
        const closeData = candles.map((c) => c.close);

        if (!ohlcvChart) {
          ohlcvChart = new Chart(ctxOhlcv, {
            type: "line",
            data: {
              labels: labelsOhlc,
              datasets: [
                {
                  label: "BTC záróár (1H, USD)",
                  data: closeData,
                  borderWidth: 1,
                  tension: 0.2,
                  pointRadius: 0,
                },
              ],
            },
            options: {
              responsive: true,
              scales: {
                x: {
                  title: { display: true, text: "Idő (utolsó ~200 óra)" },
                },
                y: {
                  title: { display: true, text: "BTC ár (USD)" },
                },
              },
            },
          });
        } else {
          ohlcvChart.data.labels = labelsOhlc;
          ohlcvChart.data.datasets[0].data = closeData;
          ohlcvChart.update();
        }

        // ----- Intraday 1m -----
        const intraday = state.intraday_1m || [];
        const labelsIntra = intraday.map((p) => p.time);
        const pricesIntra = intraday.map((p) => p.price);

        if (!intradayChart) {
          intradayChart = new Chart(ctxIntraday, {
            type: "line",
            data: {
              labels: labelsIntra,
              datasets: [
                {
                  label: "BTC ár (1m, USD)",
                  data: pricesIntra,
                  borderWidth: 1,
                  tension: 0.1,
                  pointRadius: 0,
                },
              ],
            },
            options: {
              responsive: true,
              scales: {
                x: {
                  title: { display: true, text: "Idő (mai nap, percek)" },
                },
                y: {
                  title: { display: true, text: "BTC ár (USD)" },
                },
              },
            },
          });
        } else {
          intradayChart.data.labels = labelsIntra;
          intradayChart.data.datasets[0].data = pricesIntra;
          intradayChart.update();
        }

        // ----- Sentiment -----
        const sent = state.sentiment || {
          timestamps: [],
          news_sentiment: [],
          fear_greed: [],
          latest: {},
        };
        const sentLabels = sent.timestamps || [];
        const sentNews = sent.news_sentiment || [];
        const sentFG = sent.fear_greed || [];

        if (!sentimentChart) {
          sentimentChart = new Chart(ctxSent, {
            type: "line",
            data: {
              labels: sentLabels,
              datasets: [
                {
                  label: "News sentiment",
                  data: sentNews,
                  yAxisID: "y1",
                  borderWidth: 1,
                  tension: 0.2,
                  pointRadius: 0,
                },
                {
                  label: "Fear & Greed index",
                  data: sentFG,
                  yAxisID: "y2",
                  borderWidth: 1,
                  tension: 0.2,
                  pointRadius: 0,
                },
              ],
            },
            options: {
              responsive: true,
              scales: {
                x: {
                  title: { display: true, text: "Idő (napok)" },
                },
                y1: {
                  position: "left",
                  beginAtZero: true,
                  title: { display: true, text: "News sentiment (VADER)" },
                  suggestedMin: -1,
                  suggestedMax: 1,
                },
                y2: {
                  position: "right",
                  beginAtZero: true,
                  title: { display: true, text: "Fear & Greed index" },
                  suggestedMin: 0,
                  suggestedMax: 100,
                  grid: { drawOnChartArea: false },
                },
              },
            },
          });
        } else {
          sentimentChart.data.labels = sentLabels;
          sentimentChart.data.datasets[0].data = sentNews;
          sentimentChart.data.datasets[1].data = sentFG;
          sentimentChart.update();
        }

        // ----- Hosszútávú görbe + szórássáv -----
        const curve = state.long_curve || {
          labels: [],
          pred_price: [],
          pred_price_low: [],
          pred_price_high: [],
        };

        const curveLabels = curve.labels || [];
        const curveMain = curve.pred_price || [];
        const curveLow = curve.pred_price_low || [];
        const curveHigh = curve.pred_price_high || [];

        if (!longCurveChart) {
          longCurveChart = new Chart(ctxLong, {
            type: "line",
            data: {
              labels: curveLabels,
              datasets: [
                {
                  label: "Várható BTC ár 5 év múlva",
                  data: curveMain,
                  borderWidth: 2,
                  tension: 0.2,
                  pointRadius: 3,
                },
                {
                  label: "Alsó sáv (≈ -1σ)",
                  data: curveLow,
                  borderWidth: 1,
                  tension: 0.2,
                  pointRadius: 0,
                  borderDash: [5, 5],
                },
                {
                  label: "Felső sáv (≈ +1σ)",
                  data: curveHigh,
                  borderWidth: 1,
                  tension: 0.2,
                  pointRadius: 0,
                  borderDash: [5, 5],
                },
              ],
            },
            options: {
              responsive: true,
              scales: {
                x: {
                  title: { display: true, text: "Év (current_timestamp)" },
                },
                y: {
                  title: {
                    display: true,
                    text: "Modellezett BTC ár 5 év múlva (USD)",
                  },
                  ticks: {
                    callback: (value) => value.toLocaleString(),
                  },
                },
              },
            },
          });
        } else {
          longCurveChart.data.labels = curveLabels;
          longCurveChart.data.datasets[0].data = curveMain;
          longCurveChart.data.datasets[1].data = curveLow;
          longCurveChart.data.datasets[2].data = curveHigh;
          longCurveChart.update();
        }
      }

      function updateInfoPanels(state) {
        const advice = state.advice || {};
        const sentiment = state.sentiment || {};
        const latestSent = sentiment.latest || {};

        const signalElem = document.getElementById("signal");
        const lastCloseElem = document.getElementById("last_close");
        const nextPriceElem = document.getElementById("next_price_pred");
        const relChangeElem = document.getElementById("rel_change_pred");
        const fgElem = document.getElementById("fg_value");
        const newsSentElem = document.getElementById("news_sent_value");
        const errorElem = document.getElementById("model_error");

        signalElem.textContent = advice.signal || "–";
        lastCloseElem.textContent =
          advice.last_close != null ? advice.last_close.toFixed(2) : "–";
        nextPriceElem.textContent =
          advice.next_price_pred != null
            ? advice.next_price_pred.toFixed(2)
            : "–";

        if (advice.rel_change_pred != null) {
          relChangeElem.textContent = (advice.rel_change_pred * 100).toFixed(2);
        } else {
          relChangeElem.textContent = "–";
        }

        const fg = advice.fear_greed ?? latestSent.fear_greed;
        const ns = advice.news_sentiment ?? latestSent.news_sentiment;

        fgElem.textContent = fg != null ? fg : "–";
        newsSentElem.textContent = ns != null ? ns.toFixed(3) : "–";

        if (advice.signal === "ERROR" && advice.error) {
          errorElem.textContent = "Model hiba: " + advice.error;
        } else {
          errorElem.textContent = "";
        }
      }

      function updateAdjustedPanel(adjustedPayload) {
        const base = adjustedPayload.base || {};
        const adj = adjustedPayload.adjusted || {};

        lastAdjusted = adjustedPayload;

        const baseSignal = document.getElementById("base_signal");
        const llmSignal = document.getElementById("llm_signal");
        const llmChange = document.getElementById("llm_change");
        const llmRisk = document.getElementById("llm_risk");
        const llmMode = document.getElementById("llm_mode");
        const llmNote = document.getElementById("llm_note");

        baseSignal.textContent = base.signal || "–";
        llmSignal.textContent = adj.adjusted_signal || base.signal || "–";
        llmChange.textContent =
          adj.adjusted_change_pct != null
            ? adj.adjusted_change_pct.toFixed(2)
            : "–";
        llmRisk.textContent =
          adj.risk_score != null ? adj.risk_score.toFixed(3) : "–";
        llmMode.textContent = adj.used_llm ? "LLM (Gemini)" : "Heurisztika";
        llmNote.textContent = adj.note || adj.explanation || "";
      }

      async function handleChatSubmit(event) {
        event.preventDefault();
        const question = document.getElementById("chat_question").value.trim();
        const statusEl = document.getElementById("chat_status");
        const answerEl = document.getElementById("chat_answer");

        if (!question) {
          statusEl.textContent = "Adj meg egy kérdést.";
          return;
        }

        statusEl.textContent = "Küldés...";
        answerEl.textContent = "";

        try {
          const resp = await fetch("/api/llm/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ question }),
          });
          const data = await resp.json();
          if (resp.ok) {
            answerEl.textContent = data.answer || "Nincs válasz.";
            statusEl.textContent = data.used_llm
              ? "LLM válasz (Gemini)"
              : "Heurisztikus válasz";
          } else {
            statusEl.textContent = "Hiba";
            answerEl.textContent = data.error || "Ismeretlen hiba";
          }
        } catch (err) {
          statusEl.textContent = "Hálózati hiba";
          answerEl.textContent = err?.message || String(err);
        }
      }

      async function refresh() {
        try {
          const [state, adjustedPayload] = await Promise.all([
            fetchState(),
            fetchAdjusted(),
          ]);
          upsertCharts(state);
          updateInfoPanels(state);
          updateAdjustedPanel(adjustedPayload);
        } catch (e) {
          console.error(e);
        }
      }

      // Első betöltéskor:
      refresh();
      // 60 másodpercenként frissítés:
      setInterval(refresh, 60000);

      document
        .getElementById("chatForm")
        .addEventListener("submit", handleChatSubmit);
    </script>
  </body>
</html>
