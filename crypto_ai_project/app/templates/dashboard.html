<!doctype html>
<html lang="hu">

<head>
    <meta charset="utf-8">
    <title>Crypto AI Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Egyszerű Tailwind CDN (opcionális, csak szebb legyen) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-slate-900 text-slate-100">
    <div class="min-h-screen p-4 md:p-8">
        <h1 class="text-2xl md:text-3xl font-bold mb-4">
            Bitcoin AI Advisor Dashboard
        </h1>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
            <!-- Modell jelzés -->
            <div class="bg-slate-800 rounded-xl p-4">
                <h2 class="text-lg font-semibold mb-2">Jelzés</h2>
                <div id="signal" class="text-3xl font-bold">–</div>
                <div class="mt-2 text-sm text-slate-300">
                    <div>Utolsó záróár: <span id="last_close">–</span> USD</div>
                    <div>Következő ár predikció: <span id="next_price_pred">–</span> USD</div>
                    <div>Várható változás: <span id="rel_change_pred">–</span> %</div>
                </div>
                <div class="mt-3 text-xs text-slate-400" id="model_error"></div>
            </div>

            <!-- Fear & Greed + News sentiment -->
            <div class="bg-slate-800 rounded-xl p-4">
                <h2 class="text-lg font-semibold mb-2">Hangulat</h2>
                <div>Fear &amp; Greed: <span id="fg_value">–</span></div>
                <div>News sentiment: <span id="news_sent_value">–</span></div>
                <canvas id="sentimentChart" class="mt-3"></canvas>
            </div>

            <!-- Intraday info -->
            <div class="bg-slate-800 rounded-xl p-4">
                <h2 class="text-lg font-semibold mb-2">Intraday (1m)</h2>
                <canvas id="intradayChart"></canvas>
            </div>
        </div>

        <!-- 1H OHLCV chart -->
        <div class="bg-slate-800 rounded-xl p-4">
            <h2 class="text-lg font-semibold mb-2">BTCUSDT – 1H OHLCV</h2>
            <canvas id="ohlcvChart"></canvas>
        </div>
    </div>

    <script>
        let ohlcvChart = null;
        let intradayChart = null;
        let sentimentChart = null;

        async function fetchState() {
            const resp = await fetch("/api/state");
            return await resp.json();
        }

        function upsertCharts(state) {
            const ctxOhlcv = document.getElementById("ohlcvChart").getContext("2d");
            const ctxIntraday = document.getElementById("intradayChart").getContext("2d");
            const ctxSent = document.getElementById("sentimentChart").getContext("2d");

            // ----- 1H OHLCV -----
            const candles = state.candles_1h || [];
            const labelsOhlc = candles.map(c => c.time);
            const closeData = candles.map(c => c.close);

            if (!ohlcvChart) {
                ohlcvChart = new Chart(ctxOhlcv, {
                    type: "line",
                    data: {
                        labels: labelsOhlc,
                        datasets: [{
                            label: "Close (1H)",
                            data: closeData,
                            borderWidth: 1,
                            tension: 0.2
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                ticks: { display: false }
                            }
                        }
                    }
                });
            } else {
                ohlcvChart.data.labels = labelsOhlc;
                ohlcvChart.data.datasets[0].data = closeData;
                ohlcvChart.update();
            }

            // ----- Intraday 1m -----
            const intraday = state.intraday_1m || [];
            const labelsIntra = intraday.map(p => p.time);
            const pricesIntra = intraday.map(p => p.price);

            if (!intradayChart) {
                intradayChart = new Chart(ctxIntraday, {
                    type: "line",
                    data: {
                        labels: labelsIntra,
                        datasets: [{
                            label: "Close (1m)",
                            data: pricesIntra,
                            borderWidth: 1,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                ticks: { display: false }
                            }
                        }
                    }
                });
            } else {
                intradayChart.data.labels = labelsIntra;
                intradayChart.data.datasets[0].data = pricesIntra;
                intradayChart.update();
            }

            // ----- Sentiment -----
            const sent = state.sentiment || { timestamps: [], news_sentiment: [], fear_greed: [] };
            const sentLabels = sent.timestamps || [];
            const sentNews = sent.news_sentiment || [];
            const sentFG = sent.fear_greed || [];

            if (!sentimentChart) {
                sentimentChart = new Chart(ctxSent, {
                    type: "line",
                    data: {
                        labels: sentLabels,
                        datasets: [
                            {
                                label: "News sentiment",
                                data: sentNews,
                                yAxisID: "y1",
                                borderWidth: 1,
                                tension: 0.2
                            },
                            {
                                label: "Fear & Greed",
                                data: sentFG,
                                yAxisID: "y2",
                                borderWidth: 1,
                                tension: 0.2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                ticks: { display: false }
                            },
                            y1: {
                                position: "left",
                                beginAtZero: true
                            },
                            y2: {
                                position: "right",
                                beginAtZero: true
                            }
                        }
                    }
                });
            } else {
                sentimentChart.data.labels = sentLabels;
                sentimentChart.data.datasets[0].data = sentNews;
                sentimentChart.data.datasets[1].data = sentFG;
                sentimentChart.update();
            }
        }

        function updateInfoPanels(state) {
            const advice = state.advice || {};
            const sentiment = state.sentiment || {};
            const latestSent = sentiment.latest || {};

            const signalElem = document.getElementById("signal");
            const lastCloseElem = document.getElementById("last_close");
            const nextPriceElem = document.getElementById("next_price_pred");
            const relChangeElem = document.getElementById("rel_change_pred");
            const fgElem = document.getElementById("fg_value");
            const newsSentElem = document.getElementById("news_sent_value");
            const errorElem = document.getElementById("model_error");

            signalElem.textContent = advice.signal || "–";
            lastCloseElem.textContent = advice.last_close != null ? advice.last_close.toFixed(2) : "–";
            nextPriceElem.textContent = advice.next_price_pred != null ? advice.next_price_pred.toFixed(2) : "–";

            if (advice.rel_change_pred != null) {
                relChangeElem.textContent = (advice.rel_change_pred * 100).toFixed(2);
            } else {
                relChangeElem.textContent = "–";
            }

            const fg = advice.fear_greed ?? latestSent.fear_greed;
            const ns = advice.news_sentiment ?? latestSent.news_sentiment;

            fgElem.textContent = fg != null ? fg : "–";
            newsSentElem.textContent = ns != null ? ns.toFixed(3) : "–";

            if (advice.signal === "ERROR" && advice.error) {
                errorElem.textContent = "Model hiba: " + advice.error;
            } else {
                errorElem.textContent = "";
            }
        }

        async function refresh() {
            try {
                const state = await fetchState();
                upsertCharts(state);
                updateInfoPanels(state);
            } catch (e) {
                console.error(e);
            }
        }

        // Első betöltéskor:
        refresh();
        // 60 másodpercenként frissítsük:
        setInterval(refresh, 60000);
    </script>
</body>

</html>