<!DOCTYPE html>
<html lang="hu">

<head>
  <meta charset="utf-8" />
  <title>Crypto AI Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind (csak a kinézet miatt) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-slate-900 text-slate-100">
  <div class="min-h-screen p-4 md:p-8">
    <h1 class="text-2xl md:text-3xl font-bold mb-4">
      Bitcoin AI Advisor Dashboard
    </h1>

    <!-- LLM szekciók legfelül -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
      <!-- LLM-mel módosított jelzés -->
      <div class="bg-slate-800 rounded-xl p-4">
        <div class="flex items-start justify-between gap-3">
          <h2 class="text-lg font-semibold mb-2">LLM jelzés finomhangolva</h2>
          <button id="llm_refresh_btn" class="px-3 py-2 bg-emerald-500 text-slate-900 rounded font-semibold text-sm">
            LLM frissítés
          </button>
        </div>
        <div class="text-xs text-slate-400" id="llm_status"></div>
        <div class="text-sm text-slate-300 space-y-1">
          <div>
            <span class="text-xs text-slate-400">Alap jelzés:</span>
            <span id="base_signal">–</span>
          </div>
          <div>
            <span class="text-xs text-slate-400">LLM / heurisztika:</span>
            <span id="llm_signal" class="font-semibold">–</span>
          </div>
          <div>Változás (%): <span id="llm_change">–</span></div>
          <div>Kockázati score (0-1): <span id="llm_risk">–</span></div>
          <div>Mód: <span id="llm_mode">–</span></div>
          <div class="text-xs text-slate-400" id="llm_note"></div>
        </div>
      </div>

      <!-- LLM asszisztens (CryptoGPT) -->
      <div class="bg-slate-800 rounded-xl p-4">
        <h2 class="text-lg font-semibold mb-2">LLM asszisztens</h2>
        <form id="chatForm" class="space-y-2">
          <label class="block text-sm text-slate-300" for="chat_question">Kérdés</label>
          <textarea id="chat_question" class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-2 text-sm"
            rows="3" placeholder="Mit gondolsz a mai BTC mozgásról?"></textarea>
          <button type="submit" class="px-3 py-2 bg-emerald-500 text-slate-900 rounded font-semibold">
            Küldés
          </button>
          <span id="chat_status" class="text-xs text-slate-400"></span>
        </form>
        <div class="mt-3">
          <h3 class="text-sm font-semibold mb-1">Válasz</h3>
          <div id="chat_answer" class="bg-slate-900 border border-slate-700 rounded p-3 text-sm whitespace-pre-wrap">
          </div>
        </div>
      </div>
    </div>

    <!-- Fő dashboard panelek -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
      <!-- Modell jelzés -->
      <div class="bg-slate-800 rounded-xl p-4">
        <h2 class="text-lg font-semibold mb-2">Jelzés</h2>
        <div id="signal" class="text-3xl font-bold">–</div>
        <div class="mt-2 text-sm text-slate-300">
          <div>Utolsó záróár: <span id="last_close">–</span> USD</div>
          <div>
            Következő ár predikció: <span id="next_price_pred">–</span> USD
          </div>
          <div>Várható változás: <span id="rel_change_pred">–</span> %</div>
          <div class="text-xs text-slate-400 mt-1">
            Timestamp: <span id="advice_ts">–</span>
          </div>
        </div>
        <div class="mt-3 text-xs text-slate-400" id="model_error"></div>
      </div>

      <!-- Fear & Greed + News sentiment -->
      <div class="bg-slate-800 rounded-xl p-4">
        <h2 class="text-lg font-semibold mb-2">Hangulat</h2>
        <div>Fear &amp; Greed: <span id="fg_value">–</span></div>
        <div>News sentiment: <span id="news_sent_value">–</span></div>
        <canvas id="sentimentChart" class="mt-3"></canvas>
      </div>

      <!-- Intraday info -->
      <div class="bg-slate-800 rounded-xl p-4">
        <h2 class="text-lg font-semibold mb-2">Intraday (1m)</h2>
        <canvas id="intradayChart"></canvas>
      </div>
    </div>

    <!-- A KÉT KÉRT DIAGRAM: változatlan, csak egymás mellé tesszük -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
      <!-- 1H OHLCV chart -->
      <div class="bg-slate-800 rounded-xl p-4">
        <h2 class="text-lg font-semibold mb-2">BTCUSDT – 1H OHLCV</h2>
        <canvas id="ohlcvChart"></canvas>
      </div>

      <!-- Hosszútávú görbe + szórássáv -->
      <div class="bg-slate-800 rounded-xl p-4">
        <h2 class="text-lg font-semibold mb-2">
          Hosszútávú BTC trend (görbe + szórássáv)
        </h2>
        <canvas id="longCurveChart"></canvas>
      </div>
    </div>

    <!-- Napi hírek + döntéstámogató metrikák -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <div class="bg-slate-800 rounded-xl p-4 lg:col-span-2">
        <h2 class="text-lg font-semibold mb-2">Napi hírek (utolsó 30 napból)</h2>
        <div id="news_list" class="space-y-2 text-sm"></div>
        <div class="text-xs text-slate-400 mt-2" id="news_note"></div>
      </div>
      <div class="bg-slate-800 rounded-xl p-4">
        <h2 class="text-lg font-semibold mb-2">Döntéstámogató összkép</h2>
        <div class="text-sm text-slate-300 space-y-1">
          <div>Hozam 1h/24h/7d (%): <span id="ret_1h">–</span> / <span id="ret_24h">–</span> / <span
              id="ret_7d">–</span></div>
          <div>RSI14: <span id="mkt_rsi">–</span></div>
          <div>ATR14 (% ár): <span id="mkt_atr_pct">–</span></div>
          <div>MA21 / MA50: <span id="mkt_ma21">–</span> / <span id="mkt_ma50">–</span></div>
          <div>Fear&Greed: <span id="sum_fg">–</span></div>
          <div>NewsSent (latest/std): <span id="sum_ns">–</span> / <span id="sum_ns_std">–</span></div>
          <div>Bull/Bear ratio: <span id="sum_bull">–</span> / <span id="sum_bear">–</span></div>
          <div>S&P500 / DXY: <span id="sum_sp">–</span> / <span id="sum_dxy">–</span></div>
          <div>On-chain (tx/addr/hash): <span id="sum_tx">–</span> / <span id="sum_addr">–</span> / <span
              id="sum_hash">–</span></div>
          <div class="text-xs text-slate-400" id="sum_rationale"></div>
        </div>
      </div>
    </div>


  </div>

  <script>
    let ohlcvChart = null;
    let intradayChart = null;
    let sentimentChart = null;
    let longCurveChart = null;
    let lastAdjusted = null;
    let refreshTick = 0;
    let llmStatusClearAtTick = null;

    const LLM_STORAGE_KEY = "crypto_ai_last_adjusted";

    function setLLMStatus(text, clearAfterTicks = null) {
      const el = document.getElementById("llm_status");
      if (!el) return;
      el.textContent = text || "";
      llmStatusClearAtTick = clearAfterTicks != null ? (refreshTick + clearAfterTicks) : null;
    }

    function setLLMButtonDisabled(disabled, seconds = 0) {
      const btn = document.getElementById("llm_refresh_btn");
      if (!btn) return;
      btn.disabled = disabled;
      btn.classList.toggle("opacity-50", disabled);
      btn.classList.toggle("cursor-not-allowed", disabled);
      if (disabled && seconds > 0) {
        setTimeout(() => {
          btn.disabled = false;
          btn.classList.remove("opacity-50", "cursor-not-allowed");
        }, seconds * 1000);
      }
    }

    async function fetchState() {
      const resp = await fetch("/api/state");
      return await resp.json();
    }

    async function fetchAdjusted(forceLLM = false) {
      // Biztonság/UX: ezt a hívást csak gombnyomáskor használjuk.
      const url = forceLLM
        ? "/api/llm/adjusted_forecast?force_llm=1"
        : "/api/llm/adjusted_forecast";
      const resp = await fetch(url);
      return await resp.json();
    }

    function upsertCharts(state) {
      const ctxOhlcv = document.getElementById("ohlcvChart").getContext("2d");
      const ctxIntraday = document
        .getElementById("intradayChart")
        .getContext("2d");
      const ctxSent = document
        .getElementById("sentimentChart")
        .getContext("2d");
      const ctxLong = document
        .getElementById("longCurveChart")
        .getContext("2d");

      // ----- 1H OHLCV -----
      const candles = state.candles_1h || [];
      const labelsOhlc = candles.map((c) => c.time);
      const closeData = candles.map((c) => c.close);

      if (!ohlcvChart) {
        ohlcvChart = new Chart(ctxOhlcv, {
          type: "line",
          data: {
            labels: labelsOhlc,
            datasets: [
              {
                label: "BTC záróár (1H, USD)",
                data: closeData,
                borderWidth: 1,
                tension: 0.2,
                pointRadius: 0,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              x: {
                title: { display: true, text: "Idő (utolsó ~200 óra)" },
              },
              y: {
                title: { display: true, text: "BTC ár (USD)" },
              },
            },
          },
        });
      } else {
        ohlcvChart.data.labels = labelsOhlc;
        ohlcvChart.data.datasets[0].data = closeData;
        ohlcvChart.update();
      }

      // ----- Intraday 1m -----
      const intraday = state.intraday_1m || [];
      const labelsIntra = intraday.map((p) => p.time);
      const pricesIntra = intraday.map((p) => p.price);

      if (!intradayChart) {
        intradayChart = new Chart(ctxIntraday, {
          type: "line",
          data: {
            labels: labelsIntra,
            datasets: [
              {
                label: "BTC ár (1m, USD)",
                data: pricesIntra,
                borderWidth: 1,
                tension: 0.1,
                pointRadius: 0,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              x: {
                title: { display: true, text: "Idő (mai nap, percek)" },
              },
              y: {
                title: { display: true, text: "BTC ár (USD)" },
              },
            },
          },
        });
      } else {
        intradayChart.data.labels = labelsIntra;
        intradayChart.data.datasets[0].data = pricesIntra;
        intradayChart.update();
      }

      // ----- Sentiment -----
      const sent = state.sentiment || {
        timestamps: [],
        news_sentiment: [],
        fear_greed: [],
        latest: {},
      };
      const sentLabels = sent.timestamps || [];
      const sentNews = sent.news_sentiment || [];
      const sentFG = sent.fear_greed || [];

      if (!sentimentChart) {
        sentimentChart = new Chart(ctxSent, {
          type: "line",
          data: {
            labels: sentLabels,
            datasets: [
              {
                label: "News sentiment",
                data: sentNews,
                yAxisID: "y1",
                borderWidth: 1,
                tension: 0.2,
                pointRadius: 0,
              },
              {
                label: "Fear & Greed index",
                data: sentFG,
                yAxisID: "y2",
                borderWidth: 1,
                tension: 0.2,
                pointRadius: 0,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              x: {
                title: { display: true, text: "Idő (napok)" },
              },
              y1: {
                position: "left",
                beginAtZero: true,
                title: { display: true, text: "News sentiment (VADER)" },
                suggestedMin: -1,
                suggestedMax: 1,
              },
              y2: {
                position: "right",
                beginAtZero: true,
                title: { display: true, text: "Fear & Greed index" },
                suggestedMin: 0,
                suggestedMax: 100,
                grid: { drawOnChartArea: false },
              },
            },
          },
        });
      } else {
        sentimentChart.data.labels = sentLabels;
        sentimentChart.data.datasets[0].data = sentNews;
        sentimentChart.data.datasets[1].data = sentFG;
        sentimentChart.update();
      }

      // ----- Hosszútávú görbe + szórássáv -----
      const curve = state.long_curve || {
        labels: [],
        pred_price: [],
        pred_price_low: [],
        pred_price_high: [],
      };

      const curveLabels = curve.labels || [];
      const curveMain = curve.pred_price || [];
      const curveLow = curve.pred_price_low || [];
      const curveHigh = curve.pred_price_high || [];

      if (!longCurveChart) {
        longCurveChart = new Chart(ctxLong, {
          type: "line",
          data: {
            labels: curveLabels,
            datasets: [
              {
                label: "Várható BTC ár 5 év múlva",
                data: curveMain,
                borderWidth: 2,
                tension: 0.2,
                pointRadius: 3,
              },
              {
                label: "Alsó sáv (≈ -1σ)",
                data: curveLow,
                borderWidth: 1,
                tension: 0.2,
                pointRadius: 0,
                borderDash: [5, 5],
              },
              {
                label: "Felső sáv (≈ +1σ)",
                data: curveHigh,
                borderWidth: 1,
                tension: 0.2,
                pointRadius: 0,
                borderDash: [5, 5],
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              x: {
                title: { display: true, text: "Év (current_timestamp)" },
              },
              y: {
                title: {
                  display: true,
                  text: "Modellezett BTC ár 5 év múlva (USD)",
                },
                ticks: {
                  callback: (value) => value.toLocaleString(),
                },
              },
            },
          },
        });
      } else {
        longCurveChart.data.labels = curveLabels;
        longCurveChart.data.datasets[0].data = curveMain;
        longCurveChart.data.datasets[1].data = curveLow;
        longCurveChart.data.datasets[2].data = curveHigh;
        longCurveChart.update();
      }
    }

    function updateInfoPanels(state) {
      const advice = state.advice || {};
      const sentiment = state.sentiment || {};
      const latestSent = sentiment.latest || {};

      const signalElem = document.getElementById("signal");
      const lastCloseElem = document.getElementById("last_close");
      const nextPriceElem = document.getElementById("next_price_pred");
      const relChangeElem = document.getElementById("rel_change_pred");
      const tsElem = document.getElementById("advice_ts");
      const fgElem = document.getElementById("fg_value");
      const newsSentElem = document.getElementById("news_sent_value");
      const errorElem = document.getElementById("model_error");

      signalElem.textContent = advice.signal || "–";
      lastCloseElem.textContent =
        advice.last_close != null ? advice.last_close.toFixed(2) : "–";
      nextPriceElem.textContent =
        advice.next_price_pred != null
          ? advice.next_price_pred.toFixed(2)
          : "–";

      // kompatibilitás: pred_change_pct vagy rel_change_pred
      if (advice.pred_change_pct != null) {
        relChangeElem.textContent = advice.pred_change_pct.toFixed(2);
      } else if (advice.rel_change_pred != null) {
        relChangeElem.textContent = (advice.rel_change_pred * 100).toFixed(2);
      } else {
        relChangeElem.textContent = "–";
      }

      tsElem.textContent = advice.timestamp || "–";

      const fg = advice.fear_greed ?? latestSent.fear_greed;
      const ns = advice.news_sentiment ?? latestSent.news_sentiment;

      fgElem.textContent = fg != null ? fg : "–";
      newsSentElem.textContent = ns != null ? ns.toFixed(3) : "–";

      if (advice.signal === "ERROR" && advice.error) {
        errorElem.textContent = "Model hiba: " + advice.error;
      } else {
        errorElem.textContent = "";
      }
    }

    function updateSummaryPanel(state) {
      const advice = state.advice || {};

      const rr = advice.recent_returns || {};
      const mkt = advice.market || {};
      const sent = advice.sentiment || {};
      const macro = advice.macro || {};
      const on = advice.onchain || {};

      const setNum = (id, val, digits = 2) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.textContent = val != null && !Number.isNaN(val) ? Number(val).toFixed(digits) : "–";
      };

      setNum("ret_1h", rr.ret_1h_pct, 2);
      setNum("ret_24h", rr.ret_24h_pct, 2);
      setNum("ret_7d", rr.ret_7d_pct, 2);

      setNum("mkt_rsi", mkt.rsi_14, 1);
      setNum("mkt_ma21", mkt.ma_21, 2);
      setNum("mkt_ma50", mkt.ma_50, 2);

      // ATR %
      const atr = mkt.atr_14;
      const lastClose = advice.last_close;
      const atrPct = atr != null && lastClose ? (atr / lastClose) * 100 : null;
      setNum("mkt_atr_pct", atrPct, 2);

      const fg = sent.fear_greed ?? advice.fear_greed;
      const ns = sent.news_sentiment ?? advice.news_sentiment;
      setNum("sum_fg", fg, 0);
      setNum("sum_ns", ns, 3);
      setNum("sum_ns_std", sent.news_sentiment_std, 3);
      setNum("sum_bull", sent.bullish_ratio, 3);
      setNum("sum_bear", sent.bearish_ratio, 3);

      setNum("sum_sp", macro.sp500_close, 2);
      setNum("sum_dxy", macro.dxy_close, 2);

      // On-chain gyors pillanatkép (nagy számoknál nem fixálunk tizedest)
      const setRaw = (id, val) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.textContent = val != null && !Number.isNaN(val) ? String(val) : "–";
      };
      setRaw("sum_tx", on.tx_count);
      setRaw("sum_addr", on.active_addresses);
      setRaw("sum_hash", on.hash_rate);

      const rationale = advice.rationale || [];
      const ratEl = document.getElementById("sum_rationale");
      if (ratEl) {
        ratEl.textContent = rationale.length ? ("Indoklás: " + rationale.join("; ")) : "";
      }
    }

    function updateNewsPanel(state) {
      const news = state.news || [];
      const list = document.getElementById("news_list");
      const note = document.getElementById("news_note");

      if (!list) return;
      list.innerHTML = "";

      if (!news.length) {
        list.innerHTML = '<div class="text-slate-400">Nincs hír adat (news_data_30d.csv üres vagy hiányzik).</div>';
        if (note) note.textContent = "Tipp: futtasd: python main.py update_data";
        return;
      }

      for (const item of news) {
        const title = item.title || "";
        const source = item.source || "";
        const ts = item.timestamp ? new Date(item.timestamp).toLocaleString() : "";
        const url = item.url || "";
        const summary = item.summary || "";

        const wrap = document.createElement("div");
        wrap.className = "bg-slate-900 border border-slate-700 rounded p-3";
        wrap.innerHTML = `
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-semibold">${title}</div>
                <div class="text-xs text-slate-400">${source} • ${ts}</div>
              </div>
              ${url ? `<a class="text-xs text-emerald-400" href="${url}" target="_blank" rel="noreferrer">link</a>` : ""}
            </div>
            ${summary ? `<div class="mt-2 text-sm text-slate-300">${summary}</div>` : ""}
          `;
        list.appendChild(wrap);
      }

      if (note) note.textContent = "";
    }

    function updateAdjustedPanel(adjustedPayload) {
      const base = adjustedPayload.base || {};
      const adj = adjustedPayload.adjusted || {};

      lastAdjusted = adjustedPayload;

      try {
        localStorage.setItem(LLM_STORAGE_KEY, JSON.stringify(adjustedPayload));
      } catch (_) {
        // ignore storage errors
      }

      const baseSignal = document.getElementById("base_signal");
      const llmSignal = document.getElementById("llm_signal");
      const llmChange = document.getElementById("llm_change");
      const llmRisk = document.getElementById("llm_risk");
      const llmMode = document.getElementById("llm_mode");
      const llmNote = document.getElementById("llm_note");

      baseSignal.textContent = base.signal || "–";
      llmSignal.textContent = adj.adjusted_signal || base.signal || "–";
      llmChange.textContent =
        adj.adjusted_change_pct != null
          ? adj.adjusted_change_pct.toFixed(2)
          : "–";
      llmRisk.textContent =
        adj.risk_score != null ? adj.risk_score.toFixed(3) : "–";
      llmMode.textContent = adj.used_llm ? "LLM (Gemini)" : "Heurisztika";
      const note = adj.note || adj.explanation || "";
      const raw = adj.llm_raw_response || "";
      llmNote.textContent = raw ? `${note}\n\nLLM nyers válasz:\n${raw}` : note;
    }

    async function handleChatSubmit(event) {
      event.preventDefault();
      const question = document.getElementById("chat_question").value.trim();
      const statusEl = document.getElementById("chat_status");
      const answerEl = document.getElementById("chat_answer");

      if (!question) {
        statusEl.textContent = "Adj meg egy kérdést.";
        return;
      }

      statusEl.textContent = "Küldés...";
      answerEl.textContent = "";

      try {
        const resp = await fetch("/api/llm/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question, allow_llm: true }),
        });
        const data = await resp.json();
        if (resp.ok) {
          answerEl.textContent = data.answer || "Nincs válasz.";
          statusEl.textContent = data.used_llm
            ? "LLM válasz (Gemini)"
            : "Heurisztikus válasz";
        } else {
          statusEl.textContent = "Hiba";
          answerEl.textContent = data.error || "Ismeretlen hiba";
        }
      } catch (err) {
        statusEl.textContent = "Hálózati hiba";
        answerEl.textContent = err?.message || String(err);
      }
    }

    async function refresh() {
      try {
        refreshTick += 1;
        const state = await fetchState();
        upsertCharts(state);
        updateInfoPanels(state);
        updateSummaryPanel(state);
        updateNewsPanel(state);

        // Az LLM panel maradjon "pinned": ne hívjunk API-t automatikusan.
        if (llmStatusClearAtTick != null && refreshTick >= llmStatusClearAtTick) {
          setLLMStatus("", null);
        }
      } catch (e) {
        console.error(e);
      }
    }

    // Első betöltéskor:
    try {
      const cached = localStorage.getItem(LLM_STORAGE_KEY);
      if (cached) {
        const parsed = JSON.parse(cached);
        if (parsed && typeof parsed === "object") {
          updateAdjustedPanel(parsed);
        }
      }
    } catch (_) {
      // ignore
    }
    refresh();
    // 60 másodpercenként frissítés:
    setInterval(refresh, 60000);

    document
      .getElementById("chatForm")
      .addEventListener("submit", handleChatSubmit);

    document.getElementById("llm_refresh_btn").addEventListener("click", async () => {
      // Cooldown: ne lehessen spam-elni a külső API-t.
      setLLMButtonDisabled(true, 15);
      setLLMStatus("LLM frissítés fut...", null);
      try {
        const adjustedPayload = await fetchAdjusted(true);
        updateAdjustedPanel(adjustedPayload);
        // Üzenet eltűnik ~4 automatikus refresh után (kb 4 perc)
        setLLMStatus("LLM frissítve. (Az üzenet hamarosan eltűnik)", 4);
      } catch (e) {
        console.error(e);
        setLLMStatus("LLM frissítés hiba (lásd console).", 4);
      }
    });
  </script>
</body>

</html>